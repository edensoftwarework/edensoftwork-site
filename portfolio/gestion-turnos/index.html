<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Reservas de Turnos - EDEN SoftWork</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../styles.css">
  <style>
    body {
      background: linear-gradient(135deg, #f4f4f4 0%, #e9ecef 100%);
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }
    .date-time-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      width: 100%;
    }
    .date-time-row div {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .date-time-row label {
      font-size: 14px;
      margin-bottom: 5px;
      color: #555;
    }
    .date-time-row input {
      flex: 1;
    }
    p {
      text-align: center;
      margin-bottom: 20px;
      color: #666;
      font-size: 16px;
    }
    input, button {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #5a67d8;
    }
    .appointments {
      margin-top: 30px;
    }
    .appointment {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .delete-btn {
      background: #e53e3e;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background: #c53030;
    }
    .edit-btn {
      background: #ffa500;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 5px;
    }
    .edit-btn:hover {
      background: #e69500;
    }
    .filters {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filters input {
      flex: 1;
      min-width: 200px;
    }
    .stats {
      margin: 20px 0;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .calendar {
      margin: 20px 0;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }
    .calendar-day {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
      min-height: 60px;
      cursor: pointer;
    }
    .calendar-day.has-appointments {
      background: #e3f2fd;
    }
    .calendar-day.past {
      background: #f5f5f5;
      color: #999;
    }
    .calendar-day.today-active {
      background: #1976d2; /* Azul oscuro */
      color: white;
    }
    .calendar-day.today-past {
      background: #616161; /* Gris oscuro */
      color: white;
    }
    .calendar-day.today-no {
      background: #757575; /* Gris más oscuro */
      color: white;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .calendar-header button {
      background: #667eea;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      position: fixed;
      top: 10%;
      left: 10%;
      right: 5%;
      bottom: 10%;
      background-color: #fefefe;
      padding: 20px;
      border: 1px solid #888;
      overflow-y: auto;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #aaa;
    }
    #modal-date {
      text-align: center;
      margin-bottom: 20px;
    }
    .time-slot {
      display: flex;
      border-bottom: 1px solid #ddd;
      padding: 10px;
      min-height: 50px;
    }
    .time-label {
      width: 60px;
      font-weight: bold;
    }
    .slot-free {
      color: #999;
      flex: 1;
    }
    .occupied {
      background: #e3f2fd;
    }
    .slot-appointments {
      flex: 1;
    }
    .appointment-item {
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .timeline {
      position: relative;
      height: 560px;
      padding-left: 70px;
      border-left: 1px solid #ddd;
    }
    .timeline-hour {
      position: relative;
      height: 40px;
      border-bottom: 1px solid #eee;
    }
    .hour-label {
      position: absolute;
      left: -60px;
      top: -10px;
      width: 50px;
      text-align: right;
      font-size: 12px;
      color: #666;
      font-weight: bold;
    }
    .hour-line {
      height: 1px;
      background: #ddd;
      margin-left: 10px;
    }
    .timeline-appointment {
      position: absolute;
      left: 80px;
      right: 10px;
      background: #667eea;
      color: white;
      padding: 5px;
      border-radius: 4px;
      font-size: 12px;
      overflow: hidden;
      z-index: 1;
      cursor: pointer;
    }
    .timeline-appointment.past-appointment {
      background: #ccc;
      color: #666;
    }
    .appt-content {
      font-weight: bold;
    }
    .action-menu {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
    }
    .action-menu button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: none;
      background: #667eea;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .action-menu button:hover {
      background: #5a67d8;
    }
    .message-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .message-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      text-align: center;
    }
    .message-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .message-close:hover {
      color: black;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Reservas de Turnos</h1>
    <p>Sistema para agregar, visualizar y gestionar turnos. Ideal para peluquerías, clínicas y talleres.</p>
    <form id="appointment-form">
      <input type="text" id="client" placeholder="Nombre del Cliente" required>
      <div class="date-time-row">
        <div>
          <label for="date">Fecha turno</label>
          <input type="date" id="date" required>
        </div>
        <div>
          <label for="start-time">Horario de inicio turno</label>
          <input type="time" id="start-time" min="08:00" max="22:00" required>
        </div>
        <div>
          <label for="end-time">Horario de fin turno</label>
          <input type="time" id="end-time" min="08:00" max="22:00" required>
        </div>
      </div>
      <button type="submit" id="submit-btn">Agregar Turno</button>
    </form>
    <div class="stats">
      <p id="stats-total">Total de turnos: 0</p>
      <p id="stats-today">Turnos hoy: 0</p>
      <p id="stats-week">Turnos esta semana: 0</p>
    </div>
    <div class="calendar">
      <div class="calendar-header">
        <button id="prev-month">&lt;</button>
        <h2 id="calendar-title">Calendario de Turnos</h2>
        <button id="next-month">&gt;</button>
      </div>
      <div id="calendar"></div>
    </div>
    <div class="filters">
      <input type="text" id="search" placeholder="Buscar por cliente">
      <button id="filter-today">Hoy</button>
      <button id="filter-week">Esta Semana</button>
      <button id="filter-all">Todos</button>
    </div>
    <div class="appointments" id="appointments-list">
      <h2>Turnos Agendados</h2>
      <!-- Citas se agregarán aquí -->
    </div>
    <div id="day-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modal-date"></h3>
        <div id="time-slots"></div>
      </div>
    </div>
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <span class="close" id="edit-close">&times;</span>
        <h3>Editar Turno</h3>
        <form id="edit-form">
          <input type="text" id="edit-client" placeholder="Nombre del cliente" required>
          <div class="date-time-row">
            <div>
              <label for="edit-date">Fecha turno</label>
              <input type="date" id="edit-date" required>
            </div>
            <div>
              <label for="edit-start-time">Horario de inicio turno</label>
              <input type="time" id="edit-start-time" min="08:00" max="22:00" required>
            </div>
            <div>
              <label for="edit-end-time">Horario de fin turno</label>
              <input type="time" id="edit-end-time" min="08:00" max="22:00" required>
            </div>
          </div>
          <button type="submit">Actualizar Turno</button>
          <button type="button" id="cancel-edit">Cancelar</button>
        </form>
      </div>
    </div>
    <div id="message-modal" class="message-modal">
      <div class="message-content">
        <span class="message-close">&times;</span>
        <p id="message-text"></p>
      </div>
    </div>

    <p style="text-align: center; margin-top: 30px;"><a href="../../index.html" style="color: #667eea; text-decoration: none; font-size: 16px;">← Volver a inicio</a></p>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('appointment-form');
    const appointmentsList = document.getElementById('appointments-list');
    const searchInput = document.getElementById('search');
    const filterToday = document.getElementById('filter-today');
    const filterWeek = document.getElementById('filter-week');
    const filterAll = document.getElementById('filter-all');
    const statsTotal = document.getElementById('stats-total');
    const statsToday = document.getElementById('stats-today');
    const statsWeek = document.getElementById('stats-week');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonth = document.getElementById('prev-month');
    const nextMonth = document.getElementById('next-month');
    const calendar = document.getElementById('calendar');
    const modal = document.getElementById('day-modal');
    const modalDate = document.getElementById('modal-date');
    const modalAppointments = document.getElementById('time-slots');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editClient = document.getElementById('edit-client');
    const editDate = document.getElementById('edit-date');
    const editStartTime = document.getElementById('edit-start-time');
    const editEndTime = document.getElementById('edit-end-time');
    const cancelEdit = document.getElementById('cancel-edit');
    const editClose = document.getElementById('edit-close');
    let currentAppt = null;

    function saveAppointments() {
      localStorage.setItem('appointments', JSON.stringify(appointments));
    }

    function saveAppointments() {
      localStorage.setItem('appointments', JSON.stringify(appointments));
    }

    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!currentAppt) return;
      const client = editClient.value.trim();
      const date = editDate.value;
      const startTime = editStartTime.value;
      const endTime = editEndTime.value;
      if (!client || !date || !startTime || !endTime) {
        showMessage('Todos los campos son obligatorios.');
        return;
      }
      if (new Date(date + 'T00:00:00') < new Date(new Date().toDateString())) {
        showMessage('No puedes agendar turnos en fechas pasadas.');
        return;
      }
      if (startTime >= endTime) {
        showMessage('La hora de fin debe ser posterior a la de inicio.');
        return;
      }
      if (startTime < '08:00' || endTime > '22:00') {
        showMessage('Los turnos deben estar entre 08:00 y 22:00.');
        return;
      }
      const dayAppointments = appointments.filter(a => a.date === date && a !== currentAppt);
      const overlap = dayAppointments.some(a => (startTime < a.endTime && endTime > a.startTime));
      if (overlap) {
        showMessage('Hay un conflicto de horario con otro turno.');
        return;
      }
      // update
      currentAppt.client = client;
      currentAppt.date = date;
      currentAppt.startTime = startTime;
      currentAppt.endTime = endTime;
      localStorage.setItem('appointments', JSON.stringify(appointments));
      updateStats();
      renderCalendar();
      renderAppointments();
      // refresh day modal
      showDayAppointments(date);
      editModal.style.display = 'none';
      modal.style.display = 'none';
      showMessage('Turno actualizado correctamente.');
      currentAppt = null;
    });

    cancelEdit.addEventListener('click', () => {
      editModal.style.display = 'none';
    });

    editClose.addEventListener('click', () => {
      editModal.style.display = 'none';
    });

    editStartTime.addEventListener('change', () => {
      const start = editStartTime.value;
      if (start) {
        const [h, m] = start.split(':').map(Number);
        const endH = h + Math.floor((m + 30) / 60);
        const endM = (m + 30) % 60;
        editEndTime.value = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
      }
    });
    const closeModal = document.querySelector('.close');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');
    const messageModal = document.getElementById('message-modal');
    const messageText = document.getElementById('message-text');
    const messageClose = document.querySelector('.message-close');
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
    let filteredAppointments = [];
    let editingIndex = null;
    let isFiltered = true;
    let currentFilter = 'all';

    startTimeInput.addEventListener('change', () => {
      if (startTimeInput.value) {
        const [hours, minutes] = startTimeInput.value.split(':').map(Number);
        const endDate = new Date();
        endDate.setHours(hours, minutes + 30);
        endTimeInput.value = endDate.toTimeString().slice(0, 5);
      }
    });

    function showMessage(message) {
      messageText.textContent = message;
      messageModal.style.display = 'block';
    }

    function renderAppointments(list = filteredAppointments) {
      if (!isFiltered) {
        appointmentsList.style.display = 'none';
        return;
      }
      appointmentsList.style.display = 'block';
      const ul = appointmentsList.querySelector('ul') || document.createElement('ul');
      ul.innerHTML = '';
      if (list.length === 0) {
        appointmentsList.innerHTML = '<h2>Turnos Agendados</h2><p>No hay turnos que coincidan con la búsqueda.</p>';
        return;
      }
      list.forEach((appt, index) => {
        const li = document.createElement('li');
        li.className = 'appointment';
        li.innerHTML = `
          <span>${appt.client} - ${appt.date} ${appt.startTime} - ${appt.endTime}</span>
        `;
        li.addEventListener('click', (e) => {
          e.stopPropagation();
          // Ocultar menú anterior si existe
          const existingMenu = document.querySelector('.action-menu');
          if (existingMenu) existingMenu.remove();
          // Crear menú
          const menu = document.createElement('div');
          menu.className = 'action-menu';
          menu.style.left = e.clientX + 'px';
          menu.style.top = e.clientY + 'px';
          const isPast = new Date(appt.date + 'T00:00:00') < new Date(new Date().toDateString());
          menu.innerHTML = `
            ${isPast ? '' : '<button id="edit-btn">Editar</button>'}
            <button id="delete-btn">Eliminar</button>
          `;
          document.body.appendChild(menu);
          menu.style.display = 'block';
          // Event listeners
          if (!isPast) {
            menu.querySelector('#edit-btn').addEventListener('click', () => {
              currentAppt = appt;
              editClient.value = appt.client;
              editDate.value = appt.date;
              editStartTime.value = appt.startTime;
              editEndTime.value = appt.endTime;
              editModal.style.display = 'block';
              menu.remove();
            });
          }
          menu.querySelector('#delete-btn').addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres eliminar este turno?')) {
              deleteAppointment(appointments.indexOf(appt));
            }
            menu.remove();
          });
          // Cerrar al hacer clic fuera
          const closeMenu = (event) => {
            if (!menu.contains(event.target)) {
              menu.remove();
              document.removeEventListener('click', closeMenu);
            }
          };
          setTimeout(() => document.addEventListener('click', closeMenu), 0);
        });
        ul.appendChild(li);
      });
      appointmentsList.innerHTML = '<h2>Turnos Agendados</h2>';
      appointmentsList.appendChild(ul);
    }

    function updateStats() {
      const now = new Date();
      const today = now.toISOString().slice(0, 10);
      const total = appointments.filter(appt => appt.date >= today).length;
      const todayCount = appointments.filter(appt => appt.date === today).length;
      const weekStart = new Date(now);
      const dayOfWeek = now.getDay();
      weekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      const weekStartStr = weekStart.toISOString().slice(0, 10);
      const weekEndStr = weekEnd.toISOString().slice(0, 10);
      const weekCount = appointments.filter(appt => appt.date >= weekStartStr && appt.date <= weekEndStr).length;
      statsTotal.textContent = `Total de turnos: ${total}`;
      statsToday.textContent = `Turnos hoy: ${todayCount}`;
      statsWeek.textContent = `Turnos esta semana: ${weekCount}`;
    }

    function renderCalendar() {
      calendar.innerHTML = '';
      const now = new Date();
      const year = currentYear;
      const month = currentMonth;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      calendarTitle.textContent = `${new Date(year, month).toLocaleString('es', { month: 'long', year: 'numeric' })}`;

      // Días de la semana
      const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.textContent = day;
        calendar.appendChild(header);
      });

      // Espacios vacíos
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        calendar.appendChild(empty);
      }

      // Días del mes
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        dayDiv.textContent = day;
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasAppointments = appointments.some(appt => appt.date === dateStr);
        const isPast = new Date(dateStr) < new Date(now.toDateString());
        const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        if (isToday) {
          const activeAppointments = appointments.filter(appt => appt.date === dateStr && new Date(`${dateStr}T${appt.endTime}`) > now);
          if (activeAppointments.length > 0) {
            dayDiv.classList.add('today-active');
          } else if (hasAppointments) {
            dayDiv.classList.add('today-past');
          } else {
            dayDiv.classList.add('today-no');
          }
        } else if (hasAppointments) {
          dayDiv.classList.add('has-appointments');
        }
        if (isPast && hasAppointments && !isToday) {
          dayDiv.classList.add('past');
        }
        dayDiv.addEventListener('click', () => {
          showDayAppointments(dateStr);
        });
        calendar.appendChild(dayDiv);
      }
    }

    function filterAppointments(filter = 'all') {
      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      if (filter === 'today') {
        filteredAppointments = appointments.filter(appt => appt.date === todayStr);
        isFiltered = true;
      } else if (filter === 'week') {
        const weekStart = new Date(now);
        const dayOfWeek = now.getDay();
        weekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        const weekStartStr = weekStart.toISOString().slice(0, 10);
        const weekEndStr = weekEnd.toISOString().slice(0, 10);
        filteredAppointments = appointments.filter(appt => appt.date >= weekStartStr && appt.date <= weekEndStr);
        isFiltered = true;
      } else {
        filteredAppointments = appointments.filter(appt => appt.date >= todayStr);
        isFiltered = true;
      }
      const searchTerm = searchInput.value.toLowerCase();
      if (searchTerm) {
        filteredAppointments = filteredAppointments.filter(appt => appt.client.toLowerCase().startsWith(searchTerm));
      }
      renderAppointments();
    }

    function showDayAppointments(dateStr) {
      if (!modalDate) {
        return;
      }
      const dayAppointments = appointments.filter(appt => appt.date === dateStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
      const date = new Date(dateStr + 'T00:00:00');
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      modalDate.textContent = `Turnos para ${day}/${month}/${year}`;
      modalAppointments.innerHTML = '';
      const timelineDiv = document.createElement('div');
      timelineDiv.className = 'timeline';
      // Horas
      for (let hour = 8; hour <= 22; hour++) {
        const hourDiv = document.createElement('div');
        hourDiv.className = 'timeline-hour';
        hourDiv.innerHTML = `<div class="hour-label">${String(hour).padStart(2, '0')}:00</div><div class="hour-line"></div>`;
        timelineDiv.appendChild(hourDiv);
      }
      // Turnos
      dayAppointments.forEach(appt => {
        const [startH, startM] = appt.startTime.split(':').map(Number);
        const [endH, endM] = appt.endTime.split(':').map(Number);
        const startMinutes = (startH - 8) * 60 + startM;
        const endMinutes = (endH - 8) * 60 + endM;
        const top = (startMinutes / 60) * 40;
        const height = ((endMinutes - startMinutes) / 60) * 40;
        const apptDiv = document.createElement('div');
        apptDiv.className = 'timeline-appointment';
        apptDiv.style.top = `${top}px`;
        apptDiv.style.height = `${height}px`;
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);
        const isPast = appt.date < todayStr || (appt.date === todayStr && now > new Date(`${appt.date}T${appt.endTime}`));
        if (isPast) {
          apptDiv.classList.add('past-appointment');
        }
        apptDiv.innerHTML = `
          <div class="appt-content">${appt.startTime} - ${appt.endTime} ${appt.client}</div>
        `;
        apptDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          // Ocultar menú anterior si existe
          const existingMenu = document.querySelector('.action-menu');
          if (existingMenu) existingMenu.remove();
          // Crear menú
          const menu = document.createElement('div');
          menu.className = 'action-menu';
          menu.style.left = e.clientX + 'px';
          menu.style.top = e.clientY + 'px';
          menu.innerHTML = `
            ${isPast ? '' : '<button id="edit-btn">Editar</button>'}
            <button id="delete-btn">Eliminar</button>
          `;
          document.body.appendChild(menu);
          menu.style.display = 'block';
          // Event listeners
          if (!isPast) {
            menu.querySelector('#edit-btn').addEventListener('click', () => {
              currentAppt = appt;
              editClient.value = appt.client;
              editDate.value = appt.date;
              editStartTime.value = appt.startTime;
              editEndTime.value = appt.endTime;
              editModal.style.display = 'block';
              menu.remove();
            });
          }
          menu.querySelector('#delete-btn').addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres eliminar este turno?')) {
              deleteAppointment(appointments.indexOf(appt));
              modal.style.display = 'none';
            }
            menu.remove();
          });
          // Cerrar al hacer clic fuera
          const closeMenu = (event) => {
            if (!menu.contains(event.target)) {
              menu.remove();
              document.removeEventListener('click', closeMenu);
            }
          };
          setTimeout(() => document.addEventListener('click', closeMenu), 0);
        });
        timelineDiv.appendChild(apptDiv);
      });
      modalAppointments.appendChild(timelineDiv);
      modal.style.display = 'block';
    const closeBtn = modal.querySelector('.close');
    closeBtn.onclick = () => {
      modal.style.display = 'none';
    };
    // Cerrar modal al hacer clic fuera del contenido
    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
      if (event.target === editModal) {
        editModal.style.display = 'none';
      }
    };
      console.log('Modal displayed');
    }

    messageClose.addEventListener('click', () => messageModal.style.display = 'none');
    window.addEventListener('click', (e) => {
      if (e.target === messageModal) messageModal.style.display = 'none';
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (editModal.style.display === 'block') {
          editModal.style.display = 'none';
        } else if (modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      }
    });

    prevMonth.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });

    nextMonth.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const client = document.getElementById('client').value;
      const date = document.getElementById('date').value;
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;
      const now = new Date();
      const selectedStart = new Date(`${date}T${startTime}`);
      const selectedEnd = new Date(`${date}T${endTime}`);
      if (startTime < '08:00' || endTime < '08:00') {
        showMessage('Los turnos deben comenzar y terminar entre las 08:00 y 22:00.');
        return;
      }
      if (startTime > '22:00' || endTime > '22:00') {
        showMessage('Los turnos no pueden superar las 22:00.');
        return;
      }
      if (selectedStart <= now) {
        startTimeInput.setCustomValidity('No se pueden agendar turnos en fechas u horas pasadas.');
        startTimeInput.reportValidity();
        return;
      }
      if (selectedEnd <= selectedStart) {
        showMessage('La hora de fin debe ser posterior a la hora de inicio.');
        return;
      }
      if (editingIndex !== null) {
        appointments[editingIndex] = { client, date, startTime, endTime };
        editingIndex = null;
        document.getElementById('submit-btn').textContent = 'Agregar Turno';
      } else {
        appointments.push({ client, date, startTime, endTime });
      }
      saveAppointments();
      form.reset();
      startTimeInput.setCustomValidity('');
      filterAppointments();
      updateStats();
      renderCalendar();
    });

    searchInput.addEventListener('input', () => filterAppointments(currentFilter));
    filterToday.addEventListener('click', () => { currentFilter = 'today'; filterAppointments('today'); });
    filterWeek.addEventListener('click', () => { currentFilter = 'week'; filterAppointments('week'); });
    filterAll.addEventListener('click', () => { currentFilter = 'all'; filterAppointments('all'); });

    function deleteAppointment(index) {
      appointments.splice(index, 1);
      saveAppointments();
      filterAppointments();
      updateStats();
      renderCalendar();
    }

    function editAppointment(index) {
      const appt = appointments[index];
      document.getElementById('client').value = appt.client;
      document.getElementById('date').value = appt.date;
      document.getElementById('start-time').value = appt.startTime;
      document.getElementById('end-time').value = appt.endTime;
      editingIndex = index;
      document.getElementById('submit-btn').textContent = 'Actualizar Turno';
    }

    function editAppointmentFromModal(dateStr, index) {
      const dayAppointments = appointments.filter(appt => appt.date === dateStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
      const appt = dayAppointments[index];
      const globalIndex = appointments.indexOf(appt);
      editAppointment(globalIndex);
      modal.style.display = 'none';
    }

    function deleteAppointmentFromModal(dateStr, index) {
      const dayAppointments = appointments.filter(appt => appt.date === dateStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
      const appt = dayAppointments[index];
      const globalIndex = appointments.indexOf(appt);
      deleteAppointment(globalIndex);
      modal.style.display = 'none';
    }

    // Inicializar
    updateStats();
    renderCalendar();
    });
  </script>
</body>
</html>